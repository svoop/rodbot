version: "3.9"
x-defaults: &defaults
  build:
    context: .
    dockerfile: Dockerfile
  environment:
    - BOT_MATRIX_ACCESS_TOKEN
    - BOT_MATRIX_ROOM_ID
    - BOT_GITLAB_SECRET_TOKENS
    - BOT_GITHUB_SECRET_TOKENS
    - BOT_REDIS_URL
  restart: "unless-stopped"
services:
  web:
    <<: *defaults
    command: "bundle exec puma -b tcp://0.0.0.0:9292"
    hostname: "halluzinelle.bitcetera.com"
    ports:
      - "4280:9292"
  schedule:
    <<: *defaults
    command: "bundle exec clockwork config/clockwork.rb"
  matrix:
    <<: *defaults
    command: "bin/matrix -b http://web:9292 start"
    expose:
      - "9393"
networks:
  default:
    driver: "bridge"
    ipam:
      driver: "default"
      config:
        - subnet: "172.16.42.0/24"
    driver_opts:
      com.docker.network.bridge.name: "br-halluzinelle"
